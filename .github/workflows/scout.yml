name: Global-Macro-Scout

on:
  schedule:
    # 5ë¶„ ê°„ê²© (ë°ì´í„° ìœ ì‹¤ ë°©ì§€ ìµœì  ì£¼ê¸°)
    - cron: '*/5 * * * *'
  workflow_dispatch:

# ğŸš¨ [ë°©ì–´ì„  1] ì •ì°°ê¸°ë¼ë¦¬ ì—‰í‚¤ì§€ ì•Šê²Œ í•œ ë²ˆì— í•˜ë‚˜ë§Œ ì‹¤í–‰ë˜ë„ë¡ ì œì–´
concurrency:
  group: macro-scouting
  cancel-in-progress: true

jobs:
  run-scout:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          # ğŸš¨ [ë°©ì–´ì„  2] ì „ì²´ íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì™€ì•¼ ë¦¬ë² ì´ìŠ¤(Rebase)ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install
        # ë‚ ì§œ ì„¸íƒìš© python-dateutilì„ ê¼­ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
        run: pip install requests beautifulsoup4 pandas python-dateutil

      - name: Run
        # ì‹¤í–‰í•  íŒŒì¼ëª…ì´ 'scout_jp.py'ì¸ì§€ ë‹¤ì‹œ í™•ì¸í•˜ì‹­ì‹œì˜¤.
        run: python scout_jp.py

      - name: Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # 1. DB íŒŒì¼ ì¶”ê°€
          git add macro_intelligence.db
          
          # 2. ë³€ê²½ì‚¬í•­ í™•ì¸ í›„ ì»¤ë°‹ (ì—†ìœ¼ë©´ "no changes" ì¶œë ¥ í›„ í†µê³¼)
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ“¡ ì •ì°° ë³´ê³ : DB ì—…ë°ì´íŠ¸ ($(date +'%Y-%m-%d %H:%M'))"
          
          # 3. ğŸš¨ [ë°©ì–´ì„  3: í•µì‹¬] ì›ê²©ì˜ ìµœì‹  DBë¥¼ ê°€ì ¸ì™€ì„œ ë‚´ ì‘ì—…ë¬¼ ì•„ë˜ì— ê¹”ì•„ì¤ë‹ˆë‹¤.
          git pull --rebase origin main
          
          # 4. ì´ì œ ì•ˆì „í•˜ê²Œ í‘¸ì‹œ
          git push origin main
