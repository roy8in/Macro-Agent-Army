name: Global-Macro-Scout

on:
  schedule:
    # 5ë¶„ ê°„ê²© (ìœ ì‹¤ ë°©ì§€ë¥¼ ìœ„í•´ ê¶Œì¥)
    - cron: '*/5 * * * *'
  workflow_dispatch:

# ğŸš¨ [ì¤‘ìš”] ì •ì°°ê¸°ë¼ë¦¬ ì—‰í‚¤ì§€ ì•Šê²Œ ì°¨ë¡€ë¥¼ ì„¸ì›ë‹ˆë‹¤.
concurrency:
  group: macro-scouting
  cancel-in-progress: true

jobs:
  run-scout:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          # ğŸš¨ [í•„ìˆ˜] ì „ì²´ íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì™€ì•¼ ë¦¬ë² ì´ìŠ¤(Rebase)ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install
        # ë‚ ì§œ ì„¸íƒìš© python-dateutilì„ ê¼­ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.
        run: pip install requests beautifulsoup4 pandas python-dateutil

      - name: Run
        # ì‹¤í–‰í•  íŒŒì¼ëª…ì´ 'scout_jp.py'ì¸ì§€ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.
        run: python scout_jp.py

      - name: Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # 1. DB íŒŒì¼ ì¶”ê°€
          git add macro_intelligence.db
          
          # 2. ë³€ê²½ì‚¬í•­ í™•ì¸ í›„ ì»¤ë°‹ (ì—†ìœ¼ë©´ ìŠ¤í‚µ)
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ“¡ ì •ì°° ë³´ê³ : DB ì—…ë°ì´íŠ¸ ($(date +'%Y-%m-%d %H:%M'))"
          
          # 3. ğŸš¨ [í•µì‹¬] ë¦¬ëª¨íŠ¸ì˜ ìµœì‹  ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ë‚´ ì‘ì—…ë¬¼ì„ ê·¸ ìœ„ë¡œ ì–¹ìŠµë‹ˆë‹¤.
          git pull --rebase origin main
          
          # 4. ì´ì œ ì•ˆì „í•˜ê²Œ í‘¸ì‹œ
          git push origin main
